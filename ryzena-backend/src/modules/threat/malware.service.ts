/**
 * R.Y.Z.E.N.A. - Malware Detection Service
 * 
 * Analyzes email attachments for potential malware risks.
 * Inspects file extensions, types, and patterns.
 */

import { createLogger } from '../../shared/logger.js';
import type { Attachment } from '../email/email.types.js';
import type { MalwareResult, MalwareFindings, MalwareDetectionConfig } from './threat.types.js';

const logger = createLogger({ module: 'malware-service' });

/**
 * Default malware detection configuration
 */
const DEFAULT_CONFIG: MalwareDetectionConfig = {
  executableExtensions: [
    'exe', 'scr', 'pif', 'com', 'bat', 'cmd', 'msi', 'dll',
    'vbs', 'vbe', 'ws', 'wsf', 'wsc', 'wsh',
    'ps1', 'psm1', 'psd1', // PowerShell
    'application', 'gadget', 'msc', 'msp', 'reg',
  ],
  scriptExtensions: [
    'js', 'jse', 'jar', 'py', 'pyc', 'pyw',
    'sh', 'bash', 'csh', 'ksh', 'zsh',
    'php', 'asp', 'aspx', 'pl', 'rb',
    'hta', 'htm', 'html', // HTML can contain scripts
  ],
  macroExtensions: [
    'docm', 'xlsm', 'pptm', // Office macro-enabled
    'xls', 'doc', 'ppt', // Legacy Office (can contain macros)
    'xlam', 'xla', 'ppam', 'ppa', 'potm', 'sldm',
    'dotm', 'ods', 'odt', // Open Document formats
  ],
  archiveExtensions: [
    'zip', 'rar', '7z', 'tar', 'gz', 'bz2',
    'iso', 'img', 'cab', 'arj', 'lzh',
  ],
};

/**
 * Check if filename has double extension (e.g., document.pdf.exe)
 */
function hasDoubleExtension(filename: string): boolean {
  const dangerousExtensions = [
    ...DEFAULT_CONFIG.executableExtensions,
    ...DEFAULT_CONFIG.scriptExtensions,
  ];
  
  const parts = filename.toLowerCase().split('.');
  
  if (parts.length < 3) return false;
  
  // Check if the last extension is dangerous and there's a "decoy" extension before it
  const lastExt = parts[parts.length - 1];
  const decoyExt = parts[parts.length - 2];
  
  const decoyExtensions = ['pdf', 'doc', 'docx', 'xls', 'xlsx', 'txt', 'jpg', 'png', 'gif'];
  
  return (
    dangerousExtensions.includes(lastExt) &&
    decoyExtensions.includes(decoyExt)
  );
}

/**
 * Check if extension is executable
 */
function isExecutable(extension: string): boolean {
  return DEFAULT_CONFIG.executableExtensions.includes(extension.toLowerCase());
}

/**
 * Check if extension is a script
 */
function isScript(extension: string): boolean {
  return DEFAULT_CONFIG.scriptExtensions.includes(extension.toLowerCase());
}

/**
 * Check if extension is macro-enabled document
 */
function isMacroEnabled(extension: string): boolean {
  return DEFAULT_CONFIG.macroExtensions.includes(extension.toLowerCase());
}

/**
 * Check if extension is an archive
 */
function isArchive(extension: string): boolean {
  return DEFAULT_CONFIG.archiveExtensions.includes(extension.toLowerCase());
}

/**
 * Analyze a single attachment for malware risk
 */
function analyzeAttachment(attachment: Attachment): MalwareFindings {
  const ext = attachment.extension.toLowerCase();
  const filename = attachment.filename.toLowerCase();
  const risks: string[] = [];
  
  const executable = isExecutable(ext);
  const script = isScript(ext);
  const macro = isMacroEnabled(ext);
  const doubleExt = hasDoubleExtension(filename);
  const archive = isArchive(ext);
  
  if (executable) {
    risks.push('Executable file type');
  }
  
  if (script) {
    risks.push('Script file type');
  }
  
  if (macro) {
    risks.push('Macro-enabled document');
  }
  
  if (doubleExt) {
    risks.push('Double extension detected (potential spoofing)');
  }
  
  if (archive) {
    risks.push('Archive file (may contain hidden threats)');
  }
  
  // Check for suspicious patterns in filename
  if (/password|credential|login|account/i.test(filename)) {
    risks.push('Suspicious filename pattern');
  }
  
  // Check for very long filenames (potential buffer overflow attempt)
  if (filename.length > 200) {
    risks.push('Unusually long filename');
  }
  
  return {
    filename: attachment.filename,
    risks,
    extension: ext,
    isExecutable: executable,
    hasDoubleExtension: doubleExt,
    isMacroEnabled: macro,
    isScript: script,
  };
}

/**
 * Scan attachments for malware risk
 * @param attachments - Array of attachments to scan
 * @returns Malware scan result
 */
export function scanAttachments(attachments: Attachment[]): MalwareResult {
  const startTime = Date.now();
  const findings: MalwareFindings[] = [];
  const flaggedFiles: string[] = [];
  
  for (const attachment of attachments) {
    const finding = analyzeAttachment(attachment);
    findings.push(finding);
    
    if (finding.risks.length > 0) {
      flaggedFiles.push(attachment.filename);
    }
  }
  
  const hasRisk = flaggedFiles.length > 0;
  
  logger.info({
    action: 'malware_scan_complete',
    totalAttachments: attachments.length,
    flaggedCount: flaggedFiles.length,
    hasRisk,
    flaggedFiles: flaggedFiles.length > 0 ? flaggedFiles : undefined,
    durationMs: Date.now() - startTime,
  });
  
  return {
    hasRisk,
    flaggedFiles,
    findings,
  };
}

/**
 * Quick check if attachment has immediate risk
 */
export function hasImmediateRisk(attachment: Attachment): boolean {
  const ext = attachment.extension.toLowerCase();
  return (
    isExecutable(ext) ||
    hasDoubleExtension(attachment.filename)
  );
}

/**
 * Get risk level for attachment
 */
export function getAttachmentRiskLevel(
  attachment: Attachment
): 'high' | 'medium' | 'low' {
  const ext = attachment.extension.toLowerCase();
  
  if (isExecutable(ext) || hasDoubleExtension(attachment.filename)) {
    return 'high';
  }
  
  if (isMacroEnabled(ext) || isScript(ext)) {
    return 'medium';
  }
  
  if (isArchive(ext)) {
    return 'medium';
  }
  
  return 'low';
}

/**
 * Get malware detection configuration (for testing)
 */
export function getConfig(): MalwareDetectionConfig {
  return { ...DEFAULT_CONFIG };
}

export default {
  scanAttachments,
  hasImmediateRisk,
  getAttachmentRiskLevel,
  hasDoubleExtension,
  getConfig,
};
