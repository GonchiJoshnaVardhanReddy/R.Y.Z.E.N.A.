/**
 * R.Y.Z.E.N.A. - Malware Service Tests
 */

import { describe, it, expect } from 'vitest';
import { 
  scanAttachments, 
  hasImmediateRisk, 
  getAttachmentRiskLevel,
} from '../src/modules/threat/malware.service.js';
import type { Attachment } from '../src/modules/email/email.types.js';

/**
 * Create test attachment
 */
function createAttachment(filename: string, size = 1000): Attachment {
  const parts = filename.split('.');
  const extension = parts.length > 1 ? parts[parts.length - 1] : '';
  
  return {
    filename,
    extension,
    size,
    contentType: 'application/octet-stream',
  };
}

describe('Malware Service', () => {
  describe('scanAttachments', () => {
    it('should detect executable files', () => {
      const attachments = [
        createAttachment('program.exe'),
      ];
      
      const result = scanAttachments(attachments);
      
      expect(result.hasRisk).toBe(true);
      expect(result.flaggedFiles).toContain('program.exe');
      expect(result.findings?.[0].isExecutable).toBe(true);
    });

    it('should detect script files', () => {
      const attachments = [
        createAttachment('script.js'),
        createAttachment('automation.ps1'),
        createAttachment('shell.sh'),
      ];
      
      const result = scanAttachments(attachments);
      
      expect(result.hasRisk).toBe(true);
      expect(result.flaggedFiles).toHaveLength(3);
    });

    it('should detect double extensions', () => {
      const attachments = [
        createAttachment('document.pdf.exe'),
        createAttachment('invoice.doc.scr'),
      ];
      
      const result = scanAttachments(attachments);
      
      expect(result.hasRisk).toBe(true);
      expect(result.findings?.[0].hasDoubleExtension).toBe(true);
      expect(result.findings?.[1].hasDoubleExtension).toBe(true);
    });

    it('should detect macro-enabled documents', () => {
      const attachments = [
        createAttachment('report.docm'),
        createAttachment('spreadsheet.xlsm'),
      ];
      
      const result = scanAttachments(attachments);
      
      expect(result.hasRisk).toBe(true);
      expect(result.findings?.[0].isMacroEnabled).toBe(true);
    });

    it('should not flag safe file types', () => {
      const attachments = [
        createAttachment('document.pdf'),
        createAttachment('image.jpg'),
        createAttachment('notes.txt'),
      ];
      
      const result = scanAttachments(attachments);
      
      expect(result.hasRisk).toBe(false);
      expect(result.flaggedFiles).toHaveLength(0);
    });

    it('should detect archive files', () => {
      const attachments = [
        createAttachment('files.zip'),
        createAttachment('backup.rar'),
      ];
      
      const result = scanAttachments(attachments);
      
      expect(result.hasRisk).toBe(true);
      expect(result.flaggedFiles).toHaveLength(2);
    });

    it('should detect suspicious filename patterns', () => {
      const attachments = [
        createAttachment('password-list.txt'),
        createAttachment('account-credentials.doc'),
      ];
      
      const result = scanAttachments(attachments);
      
      expect(result.hasRisk).toBe(true);
    });

    it('should handle empty attachments array', () => {
      const result = scanAttachments([]);
      
      expect(result.hasRisk).toBe(false);
      expect(result.flaggedFiles).toHaveLength(0);
    });

    it('should detect Windows batch files', () => {
      const attachments = [
        createAttachment('setup.bat'),
        createAttachment('install.cmd'),
      ];
      
      const result = scanAttachments(attachments);
      
      expect(result.hasRisk).toBe(true);
      expect(result.findings?.[0].isExecutable).toBe(true);
    });

    it('should detect VBScript files', () => {
      const attachments = [
        createAttachment('script.vbs'),
        createAttachment('macro.vbe'),
      ];
      
      const result = scanAttachments(attachments);
      
      expect(result.hasRisk).toBe(true);
    });
  });

  describe('hasImmediateRisk', () => {
    it('should return true for executables', () => {
      const attachment = createAttachment('malware.exe');
      expect(hasImmediateRisk(attachment)).toBe(true);
    });

    it('should return true for double extensions', () => {
      const attachment = createAttachment('invoice.pdf.exe');
      expect(hasImmediateRisk(attachment)).toBe(true);
    });

    it('should return false for safe files', () => {
      const attachment = createAttachment('document.pdf');
      expect(hasImmediateRisk(attachment)).toBe(false);
    });
  });

  describe('getAttachmentRiskLevel', () => {
    it('should return high for executables', () => {
      const attachment = createAttachment('program.exe');
      expect(getAttachmentRiskLevel(attachment)).toBe('high');
    });

    it('should return medium for macros', () => {
      const attachment = createAttachment('spreadsheet.xlsm');
      expect(getAttachmentRiskLevel(attachment)).toBe('medium');
    });

    it('should return medium for scripts', () => {
      const attachment = createAttachment('code.js');
      expect(getAttachmentRiskLevel(attachment)).toBe('medium');
    });

    it('should return low for safe files', () => {
      const attachment = createAttachment('photo.jpg');
      expect(getAttachmentRiskLevel(attachment)).toBe('low');
    });
  });
});
